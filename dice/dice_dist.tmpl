{{define "main"}}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<h1>Dice Roll Distribution</h1>

<form class="card" hx-post="/update" hx-trigger="submit" hx-target="#chart-container" hx-swap="outerHTML">
    <label>Paste your rolls (one per line):</label>
    <textarea name="rolls" rows="8"></textarea>

    <label>Select Die Type:</label>
    <select name="die">
        <option value="d4">d4</option>
        <option value="d6">d6</option>
        <option value="d8">d8</option>
        <option value="d10">d10</option>
        <option value="d12">d12</option>
        <option value="d20" selected>d20</option>
    </select>

    <label style="margin-top: 1rem;">
        <input type="checkbox" name="showIdeal" checked />
        Show ideal distribution
    </label>

    <button type="submit" style="margin-top: 1rem;">Update Chart</button>
</form>

<div id="chart-container" class="card">
    <canvas id="rollChart" width="600" height="400"></canvas>
    <script type="application/json" id="chart-data">[]</script>
</div>

<script>
    function renderChart(data) {
        const ctx = document.getElementById('rollChart').getContext('2d');
        if (window.rollChartInstance) window.rollChartInstance.destroy();
        window.rollChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.value),
                datasets: [
                    {
                        label: 'Actual',
                        data: data.map(d => d.count),
                        backgroundColor: 'rgba(75, 192, 192, 0.5)'
                    },
                    ...(data[0]?.ideal !== undefined ? [{
                        label: 'Ideal',
                        data: data.map(d => d.ideal),
                        backgroundColor: 'rgba(153, 102, 255, 0.5)'
                    }] : [])
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {beginAtZero: true}
                }
            }
        });
    }

    document.body.addEventListener('htmx:afterSwap', function (e) {
        if (e.target.id === 'chart-container') {
            const json = document.getElementById('chart-data');
            if (json) {
                const chartData = JSON.parse(json.textContent);
                renderChart(chartData);
            }
        }
    });
</script>
{{end}}
