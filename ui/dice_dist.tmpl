{{define "main"}}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<a href="/" role="button" class="secondary">Back</a>
<h1>{{.Set.Name}}</h1>
<div role="grid">
    {{range .Dice}}
    <a role="button" href="/dice/view-set?set_id={{$.Set.ID}}&selected_die={{.Die.ID}}" {{if
        .Selected}}aria-current="true" {{end}}>{{.Die.Name}}</a>
    {{end}}
</div>
<div>
    <h2>{{.Set.Name}} {{.Die.Name}}</h2>
    <form action="/dice/add-roll" method="POST" id="add-rolls-form">
        <textarea name="rolls" rows="4" cols="30" placeholder="Enter rolls, one per line" autofocus></textarea><br>
        <input type="hidden" name="die_id" value="{{.Die.ID}}">
        <input type="hidden" name="set_id" value="{{.Set.ID}}">
        <button type="submit">Add Rolls</button>
    </form>
    <script>
        document.addEventListener('keydown', function(event) {
            if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                document.getElementById('add-rolls-form').submit();
            }
        });
    </script>
    <p><strong>Total rolls: </strong>{{.TotalRolls}}</p>
    <canvas id="rollChart" width="600" height="300"></canvas>
    <script type="application/json" id="chart-data">{{.JsonData}}</script>
</div>

{{if .BiasStats}}
<div class="grid">
    <article>
        <header><strong>Overall Bias Report</strong></header>
        {{if .BiasStats.SmallSampleWarning}}
        <p><strong>Warning:</strong> The sample size is too small for reliable bias detection ({{.BiasStats.TotalRolls}} rolls). At least 30 rolls are recommended.</p>
        {{else}}
            {{if .BiasStats.IsBiased}}
            <p>❌ <strong>Bias Detected.</strong> The rolls show a statistically significant deviation from fairness.</p>
            {{else}}
            <p>✅ <strong>No Bias Detected.</strong> The rolls appear to be fair.</p>
            {{end}}
        {{end}}
        <ul>
            <li><strong>Chi-Squared (χ²):</strong> {{printf "%.4f" .BiasStats.ChiSquared}}
                <details>
                    <summary>Explain</summary>
                    <em>Measures deviation from fairness. Higher is more biased.</em>
                </details>
            </li>
            <li><strong>P-Value:</strong> {{printf "%.4f" .BiasStats.PValue}}
                <details>
                    <summary>Explain</summary>
                    <em>Probability the die is fair. A value < 0.05 indicates significant bias.</em>
                </details>
            </li>
            <li><strong>Cramér's V:</strong> {{printf "%.4f" .BiasStats.CramersV}}
                <details>
                    <summary>Explain</summary>
                    <em>Bias effect size from 0 (none) to 1 (max).</em>
                </details>
            </li>
            <li><strong>Total Variation Distance:</strong> {{printf "%.4f" .BiasStats.TotalVariationDistance}}
                <details>
                    <summary>Explain</summary>
                    <em>Overall bias score from 0 (fair) to 1 (max).</em>
                </details>
            </li>
        </ul>
    </article>
    <article>
        <header><strong>Textual Summary</strong></header>
        {{range $summaryGroup := .BiasStats.Summary}}
            {{if and (ne $summaryGroup.Category "equally likely") (gt (len $summaryGroup.Faces) 0)}}
                <p>It is <em>{{$summaryGroup.Category}}</em> to roll a 
                {{$faceCount := len $summaryGroup.Faces}}
                {{range $i, $face := $summaryGroup.Faces}}
                    {{if eq $faceCount 1}}{{$face}}{{else if eq $i (sub $faceCount 1)}}and {{$face}}{{else if eq $i (sub $faceCount 2)}}{{$face}} {{else}}{{$face}}, {{end}}
                {{end}}
                .</p>
            {{end}}
        {{end}}
    </article>
    <article>
        <header><strong>Per-Face Analysis</strong></header>
        <details>
            <summary>Explain</summary>
            <p><em>The Standardized Residual shows which faces are biased. A value > 2 or < -2 is significant.</em></p>
        </details>
        <table>
            <thead>
                <tr>
                    <th>Face</th>
                    <th>Observed</th>
                    <th>Expected</th>
                    <th>Std. Residual</th>
                </tr>
            </thead>
            <tbody>
                {{range .BiasStats.PerFaceStats}}
                <tr>
                    <td>{{.Face}}</td>
                    <td>{{.ObservedFrequency}}</td>
                    <td>{{printf "%.2f" .ExpectedFrequency}}</td>
                    <td>
                        <span style="background-color: {{.ResidualColor}}; color: {{.ResidualTextColor}}; padding: 2px 8px; border-radius: 12px;">
                            {{printf "%.2f" .StandardizedResidual}}
                        </span>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </article>
</div>
{{end}}

<script>
    (function () {
        const ctx = document.getElementById('rollChart').getContext('2d');
        const data = JSON.parse(document.getElementById('chart-data').textContent);
        if (window.rollChartInstance) rollChartInstance.destroy();
        rollChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.value),
                datasets: [
                    {
                        label: 'Actual',
                        data: data.map(d => d.count),
                        backgroundColor: 'rgba(75,192,192,0.5)',
                        order: 2
                    },
                    {
                        label: 'Ideal',
                        type: 'line',
                        data: data.map(d => d.ideal),
                        borderColor: 'rgba(153,102,255,0.5)',
                        borderWidth: 4,
                        fill: false,
                        pointRadius: 0,
                        order: 1
                    }
                ]
            },
            options: {
                scales: {
                    y: {beginAtZero: true}
                }
            }
        });
    })();
</script>
{{end}}
